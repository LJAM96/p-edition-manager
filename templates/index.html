{% extends "base.html" %}

{% block content %}
  {% if message %}
    <div class="alert alert-success">{{ message }}</div>
  {% elif error %}
    <div class="alert alert-error">{{ error }}</div>
  {% endif %}

  <section class="card hero-panel">
    <div class="hero-header">
      <div>
        <p class="eyebrow">Control Center</p>
        <h2>Run Edition Manager</h2>
        <p>Launch or supervise a task without leaving your browser.</p>
      </div>
      <span class="state-pill" data-state>{{ "Running" if status.running else "Idle" }}</span>
    </div>
    <div class="hero-metrics">
      <div class="metric-tile">
        <span class="label">Operation</span>
        <strong data-flag>{{ status.current_flag or "None" }}</strong>
      </div>
      <div class="metric-tile">
        <span class="label">Exit Code</span>
        <strong data-exit>{{ status.exit_code if status.exit_code is not none else "—" }}</strong>
      </div>
      <div class="metric-tile">
        <span class="label">Progress</span>
        <strong data-progress-label>{{ status.progress }}%</strong>
      </div>
    </div>
    <div class="progress-track">
      <progress id="progressBar" max="100" value="{{ status.progress }}"></progress>
    </div>
    <div class="actions-grid">
      <button class="btn primary" data-run="all">Process Entire Library</button>
      <button class="btn" data-run="reset">Reset Editions</button>
      <button class="btn" data-run="backup">Backup Editions</button>
      <button class="btn" data-run="restore">Restore Editions</button>
      <button class="btn danger" data-cancel>Stop Current Task</button>
    </div>
  </section>

  <div class="layout-grid">
    <section class="primary-stack">
      <section class="card settings-card">
        <div class="card-header">
          <div>
            <p class="eyebrow">Step 1 · Connection &amp; Behavior</p>
            <h2>User Setup &amp; Customisation</h2>
            <p>Point Edition Manager to the correct Plex server, tune performance, and decide which modules run.</p>
          </div>
          <div class="card-hint">Remember to save after making changes.</div>
        </div>
        <form id="settingsForm" method="post" action="{{ url_for('save_settings') }}" class="settings-form">
          <div class="form-sections">
            <section class="form-panel">
              <h3>Server details</h3>
              <div class="form-grid">
                <label>Protocol
                  <select name="server_scheme">
                    <option value="http" {% if settings.server.scheme == "http" %}selected{% endif %}>HTTP</option>
                    <option value="https" {% if settings.server.scheme == "https" %}selected{% endif %}>HTTPS</option>
                  </select>
                </label>
                <label>Host or IP
                  <input type="text" name="server_host" value="{{ settings.server.host }}" required>
                </label>
                <label>Port
                  <input type="number" min="1" name="server_port" value="{{ settings.server.port }}">
                </label>
                <label>Plex Token
                  <input type="password" name="server_token" value="{{ settings.server.token }}" autocomplete="current-password">
                </label>
              </div>
              <label>Skip Libraries
                <textarea name="skip_libraries" rows="3" placeholder="Kids;Documentaries">{{ settings.server.skip_libraries }}</textarea>
              </label>
              <p class="help-text">Use new lines or semicolons to ignore entire libraries when batch processing.</p>
              <div class="connection-check">
                <button class="btn ghost" type="button" id="testConnectionBtn">Test Connection</button>
                <span id="connectionStatus" class="connection-chip" data-state="idle">Status: not checked</span>
              </div>
            </section>
            <section class="form-panel">
              <h3>Performance</h3>
              <div class="form-grid">
                <label>Max Workers
                  <input type="number" min="1" name="max_workers" value="{{ settings.performance.max_workers }}">
                </label>
                <label>Batch Size
                  <input type="number" min="1" name="batch_size" value="{{ settings.performance.batch_size }}">
                </label>
                <label>HTTP Timeout (seconds)
                  <input type="number" min="5" name="http_timeout" value="{{ settings.performance.http_timeout }}">
                </label>
              </div>
              <p class="help-text">Increase the timeout for remote servers or throttled connections.</p>
            </section>
          </div>

          <div class="module-board">
            <div class="module-header">
              <div>
                <p class="eyebrow">Modules</p>
                <h3>Choose the metadata writers &amp; reorder them</h3>
                <p class="help-text">Enabled modules run top-to-bottom. It’s safe to disable anything you don’t use.</p>
              </div>
              <span class="chip">{{ settings.modules.selected | length }} enabled</span>
            </div>
            <ul id="moduleList" class="module-list">
              {% for module in settings.modules.list %}
                <li data-module="{{ module.name }}" class="module-item {% if module.enabled %}is-enabled{% endif %}">
                  <label>
                    <input type="checkbox" {% if module.enabled %}checked{% endif %}>
                    {{ module.name }}
                  </label>
                  <div class="module-controls">
                    <button type="button" class="icon-btn" data-move="up" title="Move up">↑</button>
                    <button type="button" class="icon-btn" data-move="down" title="Move down">↓</button>
                  </div>
                </li>
              {% endfor %}
            </ul>
            <input type="hidden" name="module_order" id="moduleOrderInput">
          </div>

          <div class="form-actions">
            <button class="btn primary" type="submit">Save Settings</button>
          </div>
        </form>
      </section>

    </section>

    <section class="secondary-stack">
      <section class="card log-card">
        <div class="card-header">
          <div>
            <p class="eyebrow">Step 2 · Watch it happen</p>
            <h2>Live Logs</h2>
            <p>Everything Edition Manager prints during a run, streamed in real-time.</p>
          </div>
        </div>
        <pre id="logWindow" class="log-window" data-log>{{ status.logs | join("\n") }}</pre>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Advanced Configuration</h2>
          <p>Edit <code>config/config.ini</code> directly when you need lower-level tweaks.</p>
        </div>
        <form method="post" action="{{ url_for('update_config') }}" class="config-form">
          <textarea name="config_text" rows="16">{{ config_text }}</textarea>
          <div class="form-actions">
            <button class="btn primary" type="submit">Save Raw File</button>
          </div>
        </form>
        <p class="help-text">
          We validate the contents with Python’s <code>configparser</code> before writing to disk. Keep a backup for large edits.
        </p>
      </section>
    </section>
  </div>
{% endblock %}
